name: Build and Push Docker Images

on:
  push:
    tags:
      - '*'

env:
  H100_TORCH_REGISTRY_URL: ${{ secrets.H100_TORCH_REGISTRY_URL }}
  V100_TORCH_REGISTRY_URL: ${{ secrets.V100_TORCH_REGISTRY_URL }}
  REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
  REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}

jobs:
  build-and-push:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Parse tag name
        id: parse_tag
        run: |
          # タグ名からディレクトリ名とバージョンを抽出
          TAG_NAME=${GITHUB_REF#refs/tags/}
          DIRECTORY=$(echo $TAG_NAME | cut -d'_' -f1)
          VERSION=$(echo $TAG_NAME | cut -d'_' -f2)
          
          # 結果を出力
          echo "directory=$DIRECTORY" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # デバッグ用に表示
          echo "Tag name: $TAG_NAME"
          echo "Directory: $DIRECTORY"
          echo "Version: $VERSION"

      - name: Select registry URL
        id: select_registry
        run: |
          DIRECTORY=${{ steps.parse_tag.outputs.directory }}
          # ディレクトリ名に基づいてレジストリURLを選択
          case ${DIRECTORY,,} in
            "h100-torch")
              REGISTRY_URL=${{ env.H100_TORCH_REGISTRY_URL }}
              ;;
            "v100-torch")
              REGISTRY_URL=${{ env.V100_TORCH_REGISTRY_URL }}
              ;;
            *)
              echo "Unknown directory: $DIRECTORY"
              exit 1
              ;;
          esac
          
          # レジストリURLを出力
          echo "registry_url=$REGISTRY_URL" >> $GITHUB_OUTPUT
          
          # デバッグ用に表示
          echo "Selected registry URL: $REGISTRY_URL"

      - name: Check if Dockerfile exists
        id: check_dockerfile
        run: |
          DIRECTORY=${{ steps.parse_tag.outputs.directory }}
          if [ -f "$DIRECTORY/Dockerfile" ]; then
            echo "dockerfile_exists=true" >> $GITHUB_OUTPUT
            echo "Dockerfile found in $DIRECTORY/"
          else
            echo "dockerfile_exists=false" >> $GITHUB_OUTPUT
            echo "Dockerfile not found in $DIRECTORY/"
          fi

      - name: Set up Docker Buildx
        if: steps.check_dockerfile.outputs.dockerfile_exists == 'true'
        uses: docker/setup-buildx-action@v2

      - name: Login to Container Registry
        if: steps.check_dockerfile.outputs.dockerfile_exists == 'true'
        run: |
          echo "${{ env.REGISTRY_PASSWORD }}" | docker login ${{ steps.select_registry.outputs.registry_url }} -u ${{ env.REGISTRY_USERNAME }} --password-stdin

      - name: Build and push Docker image
        if: steps.check_dockerfile.outputs.dockerfile_exists == 'true'
        uses: docker/build-push-action@v4
        with:
          context: ${{ steps.parse_tag.outputs.directory }}
          push: true
          tags: ${{ steps.select_registry.outputs.registry_url }}/notebook-${{ steps.parse_tag.outputs.directory }}:${{ steps.parse_tag.outputs.version }}
